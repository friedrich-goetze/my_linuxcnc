o<remap_toolchange> sub

    ; save modal state and prolog
    o<prolog> call
    o10 if [#<_value> NE 1.0]
        o<remap_toolchange> return [-1]
    o10 endif
	
	; check if tool is already selected
	;
	o20 if [#<_current_tool> EQ #<selected_tool>]
	    (debug, Tool #<selected_tool> is already selected. To insert and probe tool again, press input 1 for 5 seconds. Otherwise press shorter.)
	    ; wait for user pressing button
        M66 P0 L1 Q999999
        ; wait for user releasing button
        M66 P0 L4 Q5
        o21 if [#5399 GE 0.0]
            o<epilog> call
            o<remap_toolchange> return [1]
        o21 endif
	o20 endif

    ; do default stuff
    ; this also gives access to tooltable
    M6

    ; goto tool-change possition 
    ; 
    o<safe_move_percent> call [0.25] [0.1]

    ; wait for user pressing input 1
    M66 P0 L1 Q999999

    #<offset> = 0.0
    o30 if [[#<selected_tool> GE 80.0] AND [#<selected_tool> NE 99.0]]
        (MSG, large tool detected, using probing offset)
        #<offset> = 7.0
    o30 endif

    o<probe_toollen> call [#<offset>]
    #<toollen> = [#<_value>]

    ; custom code for 3axis edge finder
    o40 if [#<selected_tool> EQ 99.0]
        (MSG, TOOL IS A EDGEFINDER)
        #<toollen> = [#<toollen> - 2.0]
    o40 endif

    o50 if [#<toollen> EQ -1.0]
        o<epilog> call
        o<remap_toolchange> return [-1.0]
    o50 endif 


    ; restore modal state
    o<epilog> call

    G10 L1 P[#<selected_tool>] Z[#<toollen>]
    G43

    (MSG, TOOLCHANGE DONE! check everything!)
    M0

o<remap_toolchange> endsub [1]
m2
